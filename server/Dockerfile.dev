FROM python:3.12-slim

# Runtime libs for numpy/scipy/lightgbm (OpenMP/Fortran)
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       libgomp1 \
       libgfortran5 \
    && rm -rf /var/lib/apt/lists/*

# uv para ejecutar con lockfile
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Trabajamos desde /app/server pero copiamos todo para que PYTHONPATH=/app sirva
WORKDIR /app
COPY . .
WORKDIR /app/server

# Ajustes b√°sicos y cache de uv en /tmp (siempre escribible)
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONPATH="/app" \
    XDG_CACHE_HOME=/tmp/.cache \
    UV_CACHE_DIR=/tmp/.cache/uv \
    UV_LINK_MODE=copy

EXPOSE 8000

# Ejecuta con uv y el lock existente
CMD ["uv", "run", "--frozen", "python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]